buildPack: none
pipelineConfig:
  pipelines:
    pullRequest:
      pipeline:
        options:
          containerOptions:
            resources:
              limits:
                memory: 8Gi
              requests:
                memory: 4Gi
        agent:
          image: gcr.io/kaniko-project
        stages:
        - name: build-and-push
          options:
            volumes:
              - name: kaniko-secret
                secret:
                  secretName: kaniko-secret
                  items:
                    - key: kaniko-secret
                      path: kaniko/kaniko-secret.json
            containerOptions:
              volumeMounts:
                - name: kaniko-secret
                  mountPath: /secrets
          environment:
          - name: GKE_SA
            value: /builder/home/jenkinsx-dev-07b8e95876b1.json
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secrets/kaniko/kaniko-secret.json
          steps:
          - image: gcr.io/kaniko-project/executor:9912ccbf8d22bbafbf971124600fbb0b13b9cbd6
            name: build-bash-image
            command: /kaniko/executor
            args:
              - --dockerfile=Dockerfile.go-alpine
              - --destination=gcr.io/jenkinsxio/dev-env-base:${inputs.params.version}-go-alpine
              - --context=/workspace/source
              - --cache-repo=gcr.io/jenkinsxio/cache
              - --cache=true
              - --cache-dir=/workspace
              - --build-arg
              - "SHELL=bash"
              - --build-arg
              - "SHELL_PACKAGES=bash-completion"
          - image: gcr.io/kaniko-project/executor:9912ccbf8d22bbafbf971124600fbb0b13b9cbd6
            name: build-zsh-image
            command: /kaniko/executor
            args:
              - --dockerfile=Dockerfile.go-alpine
              - --destination=gcr.io/jenkinsxio/dev-env-base:${inputs.params.version}-go-alpine-zsh
              - --context=/workspace/source
              - --cache-repo=gcr.io/jenkinsxio/cache
              - --cache=true
              - --cache-dir=/workspace
              - --build-arg
              - "SHELL=zsh"
              - --build-arg
              - "SHELL_PACKAGES=zsh-autosuggestions zsh-syntax-highlighting"
    release:
      pipeline:
        options:
          containerOptions:
            resources:
              limits:
                memory: 8Gi
              requests:
                memory: 4Gi
        agent:
          image: gcr.io/kaniko-project/executor:9912ccbf8d22bbafbf971124600fbb0b13b9cbd6
        stages:
        - name: release
          options:
            volumes:
              - name: kaniko-secret
                secret:
                  secretName: kaniko-secret
                  items:
                    - key: kaniko-secret
                      path: kaniko/kaniko-secret.json
            containerOptions:
              volumeMounts:
                - name: kaniko-secret
                  mountPath: /secrets
          environment:
          - name: GIT_COMMITTER_EMAIL
            value: jenkins-x@googlegroups.com
          - name: GIT_COMMITTER_NAME
            value: jenkins-x-bot
          - name: GIT_AUTHOR_EMAIL
            value: jenkins-x@googlegroups.com
          - name: GIT_AUTHOR_NAME
            value: jenkins-x-bot
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secrets/kaniko/kaniko-secret.json
          steps:
          - image: gcr.io/kaniko-project/executor:9912ccbf8d22bbafbf971124600fbb0b13b9cbd6
            command: /kaniko/executor
            args:
              - --dockerfile=Dockerfile.go-alpine
              - --destination=gcr.io/jenkinsxio/dev-env-base:${inputs.params.version}-go-alpine
              - --context=/workspace/source
              - --cache-repo=gcr.io/jenkinsxio/cache
              - --cache=true
              - --cache-dir=/workspace
              - --build-arg
              - "SHELL=bash"
              - --build-arg
              - "SHELL_PACKAGES=bash-completion"
          - image: gcr.io/kaniko-project/executor:9912ccbf8d22bbafbf971124600fbb0b13b9cbd6
            command: /kaniko/executor
            args:
              - --dockerfile=Dockerfile.go-alpine
              - --destination=gcr.io/jenkinsxio/dev-env-base:${inputs.params.version}-go-alpine-zsh
              - --context=/workspace/source
              - --cache-repo=gcr.io/jenkinsxio/cache
              - --cache=true
              - --cache-dir=/workspace
              - --build-arg
              - "SHELL=zsh"
              - --build-arg
              - "SHELL_PACKAGES=zsh-autosuggestions zsh-syntax-highlighting"
          # Create the release notes
          - name: changelog
            image: gcr.io/jenkinsxio/builder-go:0.1.571
            command: ./scripts/changelog.sh
          - name: update-bot
            image: gcr.io/jenkinsxio/builder-jx:0.1.571
            command: ./scripts/update-bot.sh
            args:
              - ${inputs.params.version}
